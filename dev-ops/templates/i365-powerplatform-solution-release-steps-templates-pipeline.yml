# iThink 365 Core 
# Power Platform Release Pipeline Tasks
# Author: Simon Doy
# Date: 2021-11-19
# Last modified: 2026-01-13
# www.ithink365.co.uk
# Description
# This pipeline releases a Power Platform solution, the assets are pulled down from a build pipeline.
# Usage
# Change the source of the pipeline that builds the artifacts.

parameters:
- name: 'PowerPlatformSolutionName'
  default: 'MyPowerPlatformSolution.zip' # e.g. MyPowerPlatformSolution.zip
  type: string 
- name: 'PowerPlatformTargetEnvironmentName'
  default: 'Power Platform Test Environment (dev.ithink365.co.uk)'
  type: string
- name: 'PowerPlatformSolutionSettingsFileName'
  default: '' # e.g. application-settings-test.json
  type: string
- name: 'KnowledgeSourceUpdate'
  default: false
  type: boolean 
- name: 'KnowledgeSourceName'
  default: '' # e.g. iThink365 Knowledge Source
  type: string
- name: 'KnowledgeSourceSiteUrl'
  default: '' # e.g. https://dev.ithink365.co.uk/sites/KnowledgeBase
  type: string 
- name: buildAsManagedSolution
  displayName: Build as Managed Solution
  type: boolean
  default: true

steps:
- task: PowerShell@2
  displayName: 'List files in directory'
  enabled: true
  inputs:
    workingDirectory: '$(Pipeline.Workspace)'
    targetType: 'inline'
    script: |
      # list items
      Get-ChildItem -Recurse

- task: qetza.replacetokens.replacetokens-task.replacetokens@6
  displayName: 'Setup Power Platform Configuration'
  inputs:
    sources: '$(Pipeline.Workspace)/**/${{ parameters.PowerPlatformSolutionSettingsFileName }}'
    encoding: 'auto'
    tokenPattern: 'doubleunderscores'
    writeBOM: true
    actionOnMissing: 'warn'
    keepToken: false
    actionOnNoFiles: 'continue'
    enableTransforms: false
    useLegacyPattern: false
    enableTelemetry: true

- task: PowerPlatformToolInstaller@2
  inputs:
    DefaultVersion: true

- pwsh: |
    $(Pipeline.Workspace)/api/drop/tools/Update-PowerPlatformSolutionKnowledgeSite.ps1 -DirectoryPath '$(Pipeline.Workspace)/api/drop/Unpacked' -KnowledgeSourceName '${{ parameters.KnowledgeSourceName }}' -SiteUrl ${{ parameters.KnowledgeSourceSiteUrl }}
  displayName: 'Update Copilot Agent Knowledge Sources'
  enabled: ${{ parameters.KnowledgeSourceUpdate }}

- task: PowerPlatformPackSolution@2
  displayName: 'Pack Power Platform Solution'
  inputs:
    SolutionSourceFolder: '$(Pipeline.Workspace)/api/drop/Unpacked'
    SolutionOutputFile: '$(Pipeline.Workspace)/api/drop/packed/${{ parameters.PowerPlatformSolutionName }}'
    ${{ if parameters.buildAsManagedSolution }}:
      SolutionType: 'Managed'
    ${{ else }}:
      SolutionType: 'Unmanaged'

- task: PowerPlatformImportSolution@2
  inputs:
    authenticationType: 'PowerPlatformSPN'
    PowerPlatformSPN: '${{ parameters.PowerPlatformTargetEnvironmentName }}'
    SolutionInputFile: '$(Pipeline.Workspace)/api/drop/packed/${{ parameters.PowerPlatformSolutionName }}'
    ${{ if ne(parameters.PowerPlatformSolutionSettingsFileName, '') }}:
      UseDeploymentSettingsFile: true
      DeploymentSettingsFile: '$(Pipeline.Workspace)/api/drop/${{ parameters.PowerPlatformSolutionSettingsFileName }}'
    ${{ else }}:
      UseDeploymentSettingsFile: false
    AsyncOperation: true
    OverwriteUnmanagedCustomizations: true
    PublishWorkflows: true
    WaitForCompletion: true
    MaxAsyncWaitTime: '60'
    StageAndUpgrade: true
    ${{ if parameters.buildAsManagedSolution }}:
      ConvertToManaged: true
    ${{ else }}:
      ConvertToManaged: false
    PublishCustomizationChanges: true
